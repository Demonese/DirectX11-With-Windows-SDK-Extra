# 我使用 WS_EX_COMPOSITED 来消除我的重绘闪烁，但它导致响应缓慢

> 原文：[I used WS_EX_COMPOSITED to get rid of my redrawing flicker, but it resulted in sluggish response](https://devblogs.microsoft.com/oldnewthing/20171018-00/?p=97245)  
> 翻译：璀境石  
> 日期：2022年10月28日  

> 注意：文章中的部分链接已失效，如果有人保存了网页的备份，欢迎联系我

一位客户启用了 [`WS_EX_COMPOSITED` 扩展窗口样式](https://msdn.microsoft.com/library/windows/desktop/ff700543(v=vs.85).aspx)，以解决其应用程序的闪烁问题。这没什么问题，但他们发现它有一个不必要的副作用：当用户抓住滚动条并开始上下滚动文档时，UI 不会平滑更新。该客户希望得到一些提示，说明他们如何在不产生缓慢的UI惩罚的情况下获得 `WS_EX_COMPOSITED` 的无闪烁优势。

我的一位同事解释道：`WS_EX_COMPOSITED` 扩展样式支持窗口上的双缓冲。这意味着控件渲染到屏幕外的缓冲区中，只有当渲染完成时，结果才会复制到屏幕上。这避免了闪烁，因为只有完全绘制的控件被放在屏幕上；您永远不会看到控件处于部分绘制状态。

问题是，为了使其工作，系统需要知道渲染何时完成。否则，它不知道何时该将后缓冲区复制到屏幕。
规则是，当您释放 DC 时，系统假定您已完成渲染。（或者在你调用 `End­Paint` 时，这在原则上相当于释放 DC。）

但有些程序获取了 DC，又从不释放。每当他们想绘制的时候，他们就会拿来绘制进去。在这种情况下，系统有一个故障保护超时，并在 100 毫秒后将后缓冲区复制到屏幕，此后每 100 毫秒再次复制一次。

如果您正在使用 `WS_EX_COMPOSITED` 扩展窗口样式进行 UI 更新，请检查您是否在准备好显示设备上下文后立即正确释放它们。不要为了方便而持有 DC。如果你这样做，那么系统不知道你什么时候完成绘制，它会以每秒 10 帧的速度从后缓冲区复制到屏幕上，这会让人感觉很慢。
